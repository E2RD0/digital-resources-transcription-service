asyncapi: 3.0.0
info:
  title: WAAS Service - Video Transcription Events
  version: 1.0.0
  description: >
    The WAAS service handles video upload events, transcribes video content,
    sends email/webhook callbacks, and dispatches success/failure events via
    RabbitMQ.
  contact:
    name: Teaching action
servers:
  production:
    host: 'rabbitmq:5672'
    protocol: amqp
    description: RabbitMQ server for event messaging in production.
  development:
    host: 'localhost:5672'
    protocol: amqp
    description: RabbitMQ server for local development.
channels:
  video_uploaded:
    address: video_uploaded
    messages:
      subscribe.message:
        $ref: '#/components/messages/VideoUploaded'
    description: The channel for receiving video upload events to start transcription.
  job_started:
    address: job_started
    messages:
      publish.message:
        $ref: '#/components/messages/JobStarted'
    description: The channel for publishing events when a transcription job starts.
  job_success:
    address: job_success
    messages:
      publish.message:
        $ref: '#/components/messages/JobSuccess'
    description: The channel for publishing events when a transcription job succeeds.
  job_failure:
    address: job_failure
    messages:
      publish.message:
        $ref: '#/components/messages/JobFailure'
    description: The channel for publishing events when a transcription job fails.
operations:
  video_uploaded.subscribe:
    action: send
    channel:
      $ref: '#/channels/video_uploaded'
    summary: Receive video upload events
    messages:
      - $ref: '#/channels/video_uploaded/messages/subscribe.message'
  job_started.publish:
    action: receive
    channel:
      $ref: '#/channels/job_started'
    summary: Publish job started events
    messages:
      - $ref: '#/channels/job_started/messages/publish.message'
  job_success.publish:
    action: receive
    channel:
      $ref: '#/channels/job_success'
    summary: Publish job success events
    messages:
      - $ref: '#/channels/job_success/messages/publish.message'
  job_failure.publish:
    action: receive
    channel:
      $ref: '#/channels/job_failure'
    summary: Publish job failure events
    messages:
      - $ref: '#/channels/job_failure/messages/publish.message'
components:
  messages:
    VideoUploaded:
      name: VideoUploaded
      title: Video Uploaded Event
      summary: Event triggered when a video is uploaded to the system.
      contentType: application/json
      payload:
        type: object
        required:
          - video
        properties:
          video:
            type: object
            required:
              - libraryId
              - uuid
              - extraFields
            properties:
              libraryId:
                type: string
                description: Unique identifier for the video library.
              uuid:
                type: string
                description: Unique identifier for the uploaded video.
              title:
                type: string
                description: Title of the uploaded video.
              email_callback:
                type: string
                format: email
                description: Email address for success/failure notifications.
              webhook_id:
                type: string
                description: Webhook ID for success/failure callbacks.
              extraFields:
                type: object
                properties:
                  tempVideoPath:
                    type: string
                    description: Temporary path of the uploaded video file.
    JobStarted:
      name: JobStarted
      title: Job Started Event
      summary: Event triggered when a transcription job starts processing.
      contentType: application/json
      payload:
        type: object
        required:
          - job_id
          - uploaded_filename
          - library_id
          - uuid
          - status
        properties:
          job_id:
            type: string
            description: Unique identifier for the transcription job.
          uploaded_filename:
            type: string
            description: Name of the uploaded video file.
          library_id:
            type: string
            description: ID of the library where the video resides.
          uuid:
            type: string
            description: UUID of the uploaded video.
          status:
            type: string
            enum:
              - started
            description: Current status of the job.
    JobSuccess:
      name: JobSuccess
      title: Job Success Event
      summary: Event triggered when a transcription job completes successfully.
      contentType: application/json
      payload:
        type: object
        required:
          - status
          - job_id
          - filename
          - url
          - duration
        properties:
          status:
            type: string
            enum:
              - success
            description: Status of the job.
          job_id:
            type: string
            description: Unique identifier for the transcription job.
          filename:
            type: string
            description: Name of the uploaded video file.
          url:
            type: string
            format: uri
            description: URL where the transcription result can be downloaded.
          duration:
            type: number
            format: float
            description: Duration of the video in seconds.
    JobFailure:
      name: JobFailure
      title: Job Failure Event
      summary: Event triggered when a transcription job fails.
      contentType: application/json
      payload:
        type: object
        required:
          - status
          - job_id
          - filename
          - error_type
          - error_value
        properties:
          status:
            type: string
            enum:
              - failure
            description: Status of the job.
          job_id:
            type: string
            description: Unique identifier for the transcription job.
          filename:
            type: string
            description: Name of the uploaded video file.
          error_type:
            type: string
            description: Type of the error encountered.
          error_value:
            type: string
            description: Detailed description of the error.
  securitySchemes:
    RabbitMQAuth:
      type: userPassword
      description: Basic authentication for RabbitMQ.
